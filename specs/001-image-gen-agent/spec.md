# 機能仕様書: 画像生成エージェント

**Feature Branch**: `001-image-gen-agent`  
**Created**: 2025-11-10  
**Status**: Draft  
**Input**: ユーザー説明: "画像生成エージェントを作る - Discord上の自然言語指示から、プロンプト設計、設定選定、画像生成、投稿、追加指示反映を自動化"

## 明確化事項

### セッション 2025-11-11

- Q: エージェントアーキテクチャ構成は？ → A: すべてのエージェント機能を1つのメインプロセスで実行（シンプル、デプロイ容易）
- Q: デフォルトの画像解像度は？ → A: 512x512
- Q: ログレベルの設定は？ → A: INFO以上（INFO、WARNING、ERROR）を記録
- Q: テスト戦略は？ → A: unittest + モック/スタブによる自動テスト、カバレッジはC1（分岐網羅）を目指す、CI/CD対応
- Q: 1回の指示で生成するデフォルト画像枚数は？ → A: 4枚
- Q: 不適切コンテンツフィルタリングの基準は？ → A: 不適切コンテンツフィルタリングは不要
- Q: プロンプト生成に使用するLLMの要件は？ → A: huihui_ai/gpt-oss-abliterated:20b-v2-q4_K_Mを使用
- Q: LoRAやモデルのダウンロード元は？ → A: 初期は自動ダウンロード機能は不要
- Q: Stable Diffusion API呼び出しのタイムアウト時間は？ → A: 10分（600秒）
- Q: Discord Botはどの方式でメッセージを検知しますか？ → A: スラッシュコマンド（/generate等）のみ
- Q: Discord Botが複数のサーバー（guild）で使用される場合、設定とデータをどのように管理しますか? → A: 各サーバー（guild）ごとに独立した設定とデータを管理する
- Q: 生成された画像と履歴データをどのくらいの期間保持しますか? → A: 無期限保持（ストレージが許す限り）
- Q: Discord APIが利用不可能な場合（障害やネットワークエラー）、システムはどう対応しますか? → A: エラーを即座にログに記録して処理を中断する
- Q: タスクキューの最大サイズ（同時に受け付ける画像生成リクエストの上限）はいくつですか? → A: 1リクエストずつ処理（並列実行なし）
- Q: 実装に使用するプログラミング言語とフレームワークは何ですか? → A: Python + discord.py + FastAPI、DB: SQLite、ORM: SQLAlchemy 2.0（async対応）、マイグレーション: Alembic、スキーマ拡張: JSONBで柔軟に対応
- Q: シークレット管理方法は？ → A: 環境変数で保管（プロセス起動時に読み込み、OSレベルの保護に依存）
- Q: 生成された画像ファイルの物理的な保存場所をどこにしますか？ → A: ローカルストレージ（SQLiteと同じディレクトリに専用フォルダを作成）
- Q: Stable Diffusion APIがエラーを返した場合（タイムアウト以外）、システムはどのように応答しますか？ → A: 即座にエラーメッセージをDiscordスレッドに投稿し、処理を中断する

## ユーザーシナリオとテスト *(必須)*

### User Story 1 - Discord経由の基本画像生成 (Priority: P1)

ユーザーがDiscordで自然言語の指示を送ると、エージェントが自動的にプロンプトを作成し、適切な設定を選択して、Stable Diffusionで画像を生成し、結果をDiscordのスレッドに投稿する。

**優先度の理由**: これは機能の中核であり、すべての他の機能の基盤となる。この機能だけでも、ユーザーは手動でのプロンプト設計や設定調整なしに画像生成ができるという価値を提供できる。

**独立テスト**: Discordでスラッシュコマンド「/generate 和風サイバーパンクの女性、夕景、彩度高め」と入力し、エージェントがプロンプトを生成し、Stable Diffusionで画像を作成し、Discordスレッドに投稿することを確認できる。

**受入れシナリオ**:

1. **Given** ユーザーがDiscordのチャンネルにアクセスできる状態で、**When** スラッシュコマンド「/generate 和風サイバーパンクの女性、夕景、彩度高め」を送信すると、**Then** Botが検知し、スレッドを作成して「画像生成中...」と応答する
2. **Given** ユーザーの指示が受信された状態で、**When** エージェントがプロンプト生成と設定選定を完了すると、**Then** Stable Diffusionに画像生成リクエストが送信される
3. **Given** 画像生成が完了した状態で、**When** 複数パターン（3-5枚程度）の画像が生成されると、**Then** すべての画像がDiscordスレッドにアップロードされ、生成に使用したパラメータ（プロンプト、LoRA、設定）が添えられる
4. **Given** 画像がスレッドに投稿された状態で、**When** ユーザーがスレッドに追加指示（「もっと明るく」）を返信すると、**Then** エージェントが直前の設定を復元し、追加指示を反映した新しい画像を生成してスレッドに追加投稿する

---

### User Story 2 - グローバル設定管理 (Priority: P2)

ユーザーがDiscordコマンドでグローバル設定（デフォルトモデル、LoRA、Stable Diffusion設定、デフォルトプロンプト）を変更すると、以降の画像生成でその設定が自動的に適用される。

**優先度の理由**: 基本的な画像生成が動作した後に、ユーザーが好みの設定を永続化できることで、毎回同じ指示を繰り返す必要がなくなり、ユーザー体験が大幅に向上する。

**独立テスト**: Discordで「/settings set model sdxl」と入力し、次回の画像生成でSDXLモデルが使用されることを確認できる。また、「/settings set default_lora anime-style」と設定し、以降の生成で自動的にそのLoRAが適用されることを確認できる。

**受入れシナリオ**:

1. **Given** ユーザーがDiscordにアクセスできる状態で、**When** 「/settings set model sdxl」コマンドを送信すると、**Then** Botが「デフォルトモデルをSDXLに設定しました」と応答し、設定が保存される
2. **Given** グローバル設定が保存された状態で、**When** 次回の画像生成指示を送信すると、**Then** 保存されたデフォルト設定（モデル、LoRA等）が自動的に適用される
3. **Given** 新しいLoRAを設定する指示を受けた状態で、**When** そのLoRAがローカルに存在しない場合、**Then** エージェントが利用可能なLoRAリストを表示し、ユーザーに手動設定を促す
4. **Given** デフォルトプロンプトが設定された状態で、**When** ユーザーが画像生成指示を送信すると、**Then** デフォルトプロンプトがユーザー指示に自動的に追加される

---

### User Story 3 - スレッド内での反復改善 (Priority: P1)

ユーザーが画像生成結果のスレッドに追加指示を返信すると、エージェントが前回の設定を復元し、追加指示の差分だけを更新して新しい画像を生成する。

**優先度の理由**: これはP1の基本画像生成フローの一部であり、ユーザーが試行錯誤しながら理想の画像に近づけるための重要な機能。この反復プロセスが機能の価値を大きく高める。

**独立テスト**: 最初の画像生成後、スレッドに「もっと明るく、笑顔にして」と返信し、エージェントが前回のプロンプトと設定を保持したまま、明るさと表情の指示だけを反映した新しい画像を生成することを確認できる。

**受入れシナリオ**:

1. **Given** 画像がスレッドに投稿された状態で、**When** ユーザーがスレッドに「もっと明るく」と返信すると、**Then** エージェントが直前の完全な設定（プロンプト、LoRA、seed等）を復元する
2. **Given** 直前の設定が復元された状態で、**When** 追加指示「もっと明るく」が解析されると、**Then** プロンプトまたは設定パラメータ（brightness等）のみが更新される
3. **Given** 更新された設定で、**When** 新しい画像が生成されると、**Then** スレッドに追加投稿され、変更された部分が明示される
4. **Given** 複数回の追加指示が行われた状態で、**When** ユーザーが「最初の設定に戻して」と指示すると、**Then** エージェントが最初の設定を復元して画像を生成する

---

### User Story 4 - Webリサーチによる設定最適化 (Priority: P3)

ユーザーがテーマや目的を指定すると、エージェントがWeb上から最新のベストプラクティス（プロンプトテクニック、推奨設定、人気のLoRA等）を自動的に収集し、要約して画像生成に反映する。

**優先度の理由**: 基本機能が動作した後の追加価値機能。ユーザーが最新のテクニックを手動で調べる手間を省き、より高品質な結果を得られるが、コア機能がなくても画像生成自体は可能。

**独立テスト**: 「アニメスタイルの風景画を生成したい」と指示し、エージェントがアニメスタイル風景画に適したプロンプトテクニックやLoRAを自動的にWebから収集し、適用した結果を生成することを確認できる。

**受入れシナリオ**:

1. **Given** ユーザーが「アニメスタイルの風景画」という指示を送信した状態で、**When** Webリサーチエージェントが有効な場合、**Then** エージェントが関連するプロンプトテクニックや推奨LoRAを検索する
2. **Given** Webリサーチが完了した状態で、**When** 収集された情報が要約されると、**Then** プロンプトエージェントがその情報を参考にして最適なプロンプトを生成する
3. **Given** 最適化された設定が提案された状態で、**When** 画像が生成されると、**Then** 使用されたWebリサーチ情報の要約がスレッドに一緒に投稿される
4. **Given** Webリサーチ機能が有効な状態で、**When** ユーザーが「リサーチなしで生成」と指定すると、**Then** Webリサーチをスキップして即座に画像生成を開始する

---

### エッジケース

- **Stable Diffusion APIが応答しない場合**: 10分（600秒）のタイムアウト後、Discordにエラーメッセージを投稿し、再試行オプションを提供する
- **Stable Diffusion APIがエラーを返した場合**: 即座にエラーメッセージをDiscordスレッドに投稿し、処理を中断する。エラー詳細をログに記録する
- **Discord APIが利用不可能な場合**: エラーを即座にログに記録して処理を中断する
- **複数ユーザーが同時に指示した場合**: 各リクエストをキューに入れ、1つずつ順次処理する（並列実行なし）。待機中のユーザーには待ち時間の見積もりを通知する
- **指定されたLoRAやモデルが存在しない場合**: エラーメッセージを表示し、利用可能なLoRA/モデルのリストを提案する（初期バージョンでは自動ダウンロード非対応）
- **生成された画像が期待と大きく異なる場合**: ユーザーは追加指示で修正できる。完全にやり直す場合は「/reset」コマンドで最初から開始できる
- **Discordのファイルサイズ制限を超える場合**: 画像を自動的に圧縮するか、外部ストレージへのリンクを提供する
- **スレッドが非常に長くなった場合（50回以上の反復）**: 新しいスレッドの作成を提案し、現在の設定を引き継ぐ
- **ユーザーがスレッド外で追加指示をした場合**: 最新のスレッドを検索して関連付けるか、新しい生成として扱うかをユーザーに確認する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはDiscordのスラッシュコマンド（/generate、/settings等）を検知し、画像生成指示を識別できること
- **FR-002**: システムはユーザーの自然言語指示からプロンプトとネガティブプロンプトを自動生成できること（使用LLM: huihui_ai/gpt-oss-abliterated:20b-v2-q4_K_M）
- **FR-003**: システムは生成された画像に使用した完全な設定（プロンプト、ネガティブプロンプト、モデル、LoRA、steps、CFG、sampler、seed、width、height等）をメタデータとして保存できること
- **FR-004**: システムは保存されたメタデータから設定を完全に復元できること
- **FR-005**: システムはサーバー（guild）ごと、ユーザーごと、スレッドごとに設定を管理できること
- **FR-006**: システムはStable Diffusion（Automatic1111 API）に画像生成リクエストを送信し、結果を取得できること（タイムアウト: 600秒）
- **FR-007**: システムは生成された画像をDiscordスレッドに投稿できること
- **FR-008**: システムはスレッド内の返信を追加指示として検知し、前回の設定に差分更新を適用できること
- **FR-009**: システムはグローバル設定（デフォルトモデル、デフォルトLoRA、デフォルトプロンプト、SD設定値、デフォルト解像度512x512）を保存・読み込みできること
- **FR-010**: システムは指定されたLoRAやモデルがローカルに存在しない場合、利用可能なLoRA/モデルリストを表示できること（初期バージョンでは自動ダウンロード非対応）
- **FR-011**: システムは1回の指示で複数パターンの画像を生成できること（デフォルト: 4枚、ユーザー指定で変更可能）
- **FR-012**: システムは各画像生成リクエストをキューで管理し、1リクエストずつ順次処理できること（並列実行なし）
- **FR-013**: システムはWebから最新のプロンプトテクニックや設定のベストプラクティスを収集し、要約できること（オプション機能）
- **FR-014**: システムは生成エラー時に適切なエラーメッセージをユーザーに通知できること
- **FR-015**: システムはファイルサイズ制限を超える画像を自動的に圧縮できること
- **FR-016**: システムはユーザーが/resetコマンドで現在のスレッドの設定履歴をクリアできること
- **FR-017**: システムはLoRAの説明文を保存し、LoRA選択時に参照できること
- **FR-018**: システムは生成された画像と履歴データを無期限に保持できること（ストレージ容量の範囲内で）
- **FR-019**: システムはシークレット（Discordボットトークン、APIキー）を環境変数経由で読み込み、アプリ起動時に利用すること

### 主要エンティティ

- **GenerationRequest**: 画像生成リクエスト。サーバーID（guild ID）、ユーザーID、スレッドID、オリジナル指示、タイムスタンプ、ステータスを含む
- **GenerationMetadata**: 画像生成に使用した完全な設定。プロンプト、ネガティブプロンプト、モデル名、LoRAリスト、steps、CFG scale、sampler、scheduler、seed、width、height、その他のパラメータを含む
- **GeneratedImage**: 生成された画像。画像ファイルパス（SQLiteと同じディレクトリ内の専用フォルダに保存）、GenerationMetadataへの参照、生成日時、Discord投稿URLを含む
- **GlobalSettings**: サーバー（guild）ごと、ユーザーごとのグローバル設定。サーバーID、デフォルトモデル、デフォルトLoRAリスト、デフォルトプロンプト、デフォルトSD設定値を含む
- **ThreadContext**: スレッドコンテキスト。サーバーID、スレッドID、ユーザーID、生成履歴（GenerationMetadataのリスト）、最新の設定状態を含む
- **LoRAMetadata**: LoRA情報。LoRA名、ファイルパス、説明文、タグ、ダウンロード日時を含む
- **QueuedTask**: タスクキュー。タスクID、タスクタイプ（画像生成/LoRAダウンロード/Webリサーチ等）、優先度、ステータス、作成日時を含む

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーがDiscordで指示を送信してから最初の画像が投稿されるまでの時間が3分以内である（Webリサーチなしの場合）
- **SC-002**: ユーザーがスレッドで追加指示を送信してから更新された画像が投稿されるまでの時間が2分以内である
- **SC-003**: システムは画像生成リクエストを1つずつ順次処理する（並列実行なし、キューイングのみ）
- **SC-004**: 生成された画像の設定が完全に再現可能である（同じseedとメタデータで100%同一の画像が生成される）
- **SC-005**: ユーザーの80%が追加指示なしで満足できる画像を得られる（初回生成の品質）
- **SC-006**: グローバル設定の変更が次回の画像生成で100%反映される
- **SC-007**: Stable Diffusion APIエラー時に、95%以上のケースでユーザーに適切なエラーメッセージが通知される
- **SC-008**: Webリサーチ機能により、手動でベストプラクティスを調べる時間が平均50%削減される
- **SC-009**: ユーザーが平均して3回以下の追加指示で目的の画像に到達できる

### 前提条件

- Stable Diffusion（Automatic1111）がローカルまたはアクセス可能なサーバーで稼働していること
- Discord Botトークンが有効であり、スラッシュコマンド権限とスレッド作成権限が付与されていること
- ローカルLLM（huihui_ai/gpt-oss-abliterated:20b-v2-q4_K_M）がOllama等の互換インターフェースを通じてアクセス可能であること
- 画像とメタデータを保存するストレージ領域が十分にあること（最低50GB推奨）
- Webリサーチ機能用のインターネット接続が利用可能であること（オプション機能）
- Python 3.10以上がインストールされていること
- SQLiteデータベースが利用可能であること

### 技術スタック

- **プログラミング言語**: Python 3.10+
- **アーキテクチャ**: 単一プロセスでの統合実行（プロンプト生成、画像生成、リサーチの各エージェント機能をモジュールとして統合）
- **Discord Bot**: discord.py
- **Webフレームワーク**: FastAPI（エージェント間通信・ヘルスチェック用）
- **データベース**: SQLite
- **ORM**: SQLAlchemy 2.0（async対応）
- **マイグレーション**: Alembic
- **スキーマ拡張**: JSONB型で柔軟に対応（例: 生成時パラメータのraw dump）
- **LLM統合**: Ollama互換インターフェース
- **Stable Diffusion統合**: Automatic1111 Web API
- **テストフレームワーク**: unittest（標準ライブラリ）、モック/スタブによる外部依存の代替
- **コードカバレッジ**: coverage.py（C1分岐網羅を目標）
- **コード品質**: Black（フォーマット）、Ruff（リント）、pre-commit（コミット前チェック）

### 非機能要件

- **NFR-001 観測性**: すべての画像生成リクエスト、LLM呼び出し、Stable Diffusion API呼び出し、エラーをINFO以上のレベル（INFO、WARNING、ERROR）でログに記録すること
- **NFR-002 パフォーマンス**: 画像生成リクエストから最初の画像投稿まで3分以内（Webリサーチなし）、追加指示への応答は2分以内
- **NFR-003 信頼性**: Stable Diffusion APIエラー時に95%以上のケースで適切なエラーメッセージをユーザーに通知すること
- **NFR-004 テスト可能性**: すべての主要機能に対してunittestによる自動テストを実装し、C1（分岐網羅）カバレッジを目指すこと。外部依存（Discord API、Stable Diffusion API、LLM）はモック/スタブで代替可能な設計とすること
- **NFR-005 CI/CD対応**: 自動テストがCI/CDパイプラインで実行可能であること。テスト失敗時はデプロイを自動的にブロックすること

- シークレット管理: シークレット（Discordボットトークン、APIキー）は環境変数で保管し、アプリ起動時に読み込む。ローカル開発では .env の利用を許容するが、本番ではOS/コンテナ側の環境変数注入を推奨する。ローテーションは運用手順で管理すること。
- 実行権限: Discordトークンは最小権限を付与する（スラッシュコマンド、スレッド作成のみ）。
- データ保護: 画像とメタデータへのアクセスはサーバー内で制限する。バックアップや外部ストレージに保存する場合は暗号化を必須とする。
